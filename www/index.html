<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probiotic Quality Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .error { color: red; padding: 1rem; }
        .success { color: green; padding: 1rem; }
    </style>
</head>
<body>
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white">
        <div class="text-center">
            <p class="mb-4">Loading WebAssembly module...</p>
            <div id="status"></div>
            <pre id="debug" class="text-left text-sm text-gray-600 mt-4"></pre>
        </div>
    </div>

    <script>
        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            status.appendChild(div);
            console.log(isError ? `Error: ${message}` : message);
        }

        function debugLog(message) {
            const debug = document.getElementById('debug');
            debug.textContent += message + '\n';
            console.log(message);
        }

        // Log current path
        debugLog(`Current path: ${window.location.href}`);
        
        // Check WebAssembly support
        if (!('WebAssembly' in window)) {
            updateStatus('WebAssembly is not supported in this browser', true);
        }
    </script>

    <script type="module">
        async function checkFile(path) {
            debugLog(`Checking file: ${path}`);
            try {
                const response = await fetch(path);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const contentLength = response.headers.get('content-length');
                debugLog(`Found file: ${path} (${contentLength} bytes)`);
                return true;
            } catch (error) {
                debugLog(`Error loading ${path}: ${error.message}`);
                return false;
            }
        }

        async function run() {
            try {
                // Check each required file
                const files = [
                    '/pkg/dashboard.js',
                    '/pkg/dashboard_bg.wasm'
                ];

                for (const file of files) {
                    updateStatus(`Checking ${file}...`);
                    const exists = await checkFile(file);
                    if (!exists) {
                        throw new Error(`Required file not found: ${file}`);
                    }
                }

                updateStatus('Loading WASM module...');
                const { default: init, initialize_dashboard } = await import('/pkg/dashboard.js');
                
                updateStatus('Initializing WASM...');
                await init();
                await initialize_dashboard();
                
                updateStatus('Dashboard ready!');
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 1000);

            } catch (error) {
                updateStatus(`Fatal error: ${error.message}`, true);
                debugLog(`Stack trace: ${error.stack}`);
            }
        }

        // Start the application
        run().catch(error => {
            updateStatus(`Startup error: ${error.message}`, true);
            debugLog(`Startup stack trace: ${error.stack}`);
        });
    </script>
</body>
</html>